<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Let's Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

<div class="app-wrapper">
    <header>
        <h1>Chat with Me</h1>
    </header>

    <div id="chat-box">
        <div class="message ai">Hello, how can I help you?</div>
    </div>

    <div class="input-area">
        <div class="input-container">
            <textarea id="user-input" placeholder="Type your message..." rows="1"></textarea>
            <button class="send-btn" onclick="executeCommand()">SEND</button>
        </div>
    </div>
</div>

<script>
const chatBox = document.getElementById("chat-box");
const userInput = document.getElementById("user-input");

/* ENTER = SEND | SHIFT+ENTER = NEW LINE */
userInput.addEventListener("keydown", function(e) {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        executeCommand();
    }
});

function appendMessage(text, type) {
    const div = document.createElement("div");
    div.className = `message ${type}`;
    div.innerHTML = type === "ai" ? marked.parse(text) : text;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
}

async function executeCommand() {
    const msg = userInput.value.trim();
    if (!msg) return;

    appendMessage(msg, "user");
    userInput.value = "";
    userInput.focus();   // Keep focus on input

    try {
        const res = await fetch("/api/chat", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ message: msg })
        });

        const data = await res.json();
        appendMessage(data.response, "ai");
        userInput.focus();   // Refocus after AI response

    } catch (err) {
        appendMessage("Connection lost. Try again.", "ai");
        userInput.focus();   // Refocus on error
    }
}
</script>

</body>
</html>
